{% extends "base.html" %}

{% block title %}Nuovo Appuntamento{% endblock %}

{% block content %}
<h1>Nuovo Appuntamento</h1>
<form method="POST">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <div class="mb-3">
        <label for="title" class="form-label">Titolo</label>
        <input type="text" class="form-control" id="title" name="title" value="{{ request.args.get('title', '') }}" required>
    </div>
    <div class="mb-3">
        <label for="notes" class="form-label">Note</label>
        <textarea class="form-control" id="notes" name="notes">{{ request.args.get('notes', '') }}</textarea>
    </div>
    <div class="mb-3">
        <label for="date_time" class="form-label">Data e Ora</label>
        <input type="datetime-local" class="form-control" id="date_time" name="date_time" 
               value="{{ prefilled_date_time }}" required>
    </div>
    <div class="mb-3">
        <label for="end_date_time" class="form-label">Data e Ora di Fine</label>
        <input type="datetime-local" class="form-control" id="end_date_time" name="end_date_time" 
               value="{{ prefilled_end_date_time }}" required>
    </div>
    <div class="mb-3">
        <label for="appointment_type" class="form-label">Tipo</label>
        <select class="form-select" id="appointment_type" name="appointment_type" required>
            <option value="Allenamento Funzionale" {% if request.args.get('appointment_type') == 'Allenamento Funzionale' %}selected{% endif %}>Allenamento Funzionale</option>
            <option value="Chiamata" {% if request.args.get('appointment_type') == 'Chiamata' %}selected{% endif %}>Chiamata</option>
            <option value="Blocco Agenda" {% if request.args.get('appointment_type') == 'Blocco Agenda' %}selected{% endif %}>Blocco Agenda</option>
            <option value="Allenamento EMS" {% if request.args.get('appointment_type') == 'Allenamento EMS' %}selected{% endif %}>Allenamento EMS</option>
        </select>
    </div>
    <div class="mb-3">
        <label for="status" class="form-label">Stato</label>
        <select class="form-select" id="status" name="status" required>
            <option value="Confermato" {% if request.args.get('status') == 'Confermato' %}selected{% endif %}>Confermato</option>
            <option value="Spostato" {% if request.args.get('status') == 'Spostato' %}selected{% endif %}>Spostato</option>
            <option value="Saltato" {% if request.args.get('status') == 'Saltato' %}selected{% endif %}>Saltato</option>
            <option value="Prova Fissata" {% if request.args.get('status') == 'Prova Fissata' %}selected{% endif %}>Prova Fissata</option>
            <option value="Prova in Chiamata" {% if request.args.get('status') == 'Prova in Chiamata' %}selected{% endif %}>Prova in Chiamata</option>
            <option value="Appuntamento Non Svolto" {% if request.args.get('status') == 'Appuntamento Non Svolto' %}selected{% endif %}>Appuntamento Non Svolto</option>
        </select>
    </div>
    <div class="mb-3">
        <label for="client_id" class="form-label">Cliente</label>
        <select class="form-select" id="client_id" name="client_id" required>
            {% for cliente in clienti %}
            <option value="{{ cliente.id }}" {% if request.args.get('client_id') == cliente.id|string %}selected{% endif %}>
                {{ cliente.nome }} {{ cliente.cognome }}
            </option>
            {% endfor %}
        </select>
    </div>
    <div class="form-check">
        <input class="form-check-input" type="checkbox" id="is_trial" name="is_trial">
        <label class="form-check-label" for="is_trial">Prova</label>
    </div>
    <div class="form-check">
        <input class="form-check-input" type="checkbox" id="is_recovery" name="is_recovery">
        <label class="form-check-label" for="is_recovery">Recupero</label>
    </div>
    <div class="form-check">
        <input class="form-check-input" type="checkbox" id="is_lesson_zero" name="is_lesson_zero">
        <label class="form-check-label" for="is_lesson_zero">Lezione 0</label>
    </div>
    <div class="form-check">
        <input class="form-check-input" type="checkbox" id="is_recurring" name="is_recurring">
        <label class="form-check-label" for="is_recurring">Ripetuto</label>
    </div>
    <div id="recurring-options" style="display: none;">
        <div class="mb-3">
            <label for="duration" class="form-label">Durata (minuti)</label>
            <input type="number" class="form-control" id="duration" name="duration" min="1">
        </div>
        <div class="mb-3">
            <label for="day_of_week" class="form-label">Giorno della settimana</label>
            <input type="text" class="form-control" id="day_of_week" name="day_of_week" readonly>
        </div>
    </div>
    <div class="mb-3" id="package-selection" style="display: none;">
        <label for="package_id" class="form-label">Seleziona Pacchetto</label>
        <select class="form-select" id="package_id" name="package_id">
            <!-- I pacchetti verranno caricati dinamicamente -->
        </select>
    </div>
    <button type="submit" class="btn btn-success mt-3">Aggiungi</button>
</form>

<script>
    const appointmentType = document.getElementById('appointment_type');
    const clientSelect = document.getElementById('client_id');
    const titleInput = document.getElementById('title');
    const packageSelect = document.getElementById('package_id');
    const packageSelection = document.getElementById('package-selection');

    // Funzione per aggiornare il titolo in base al cliente selezionato
    function updateTitle() {
        if (appointmentType.value === 'Blocco Agenda') {
            titleInput.value = 'Blocco Agenda';
        } else {
            const selectedClient = clientSelect.options[clientSelect.selectedIndex];
            titleInput.value = selectedClient ? selectedClient.text : '';
        }
    }

    // Mostra o nasconde il campo "Seleziona Pacchetto" in base al tipo di appuntamento
    appointmentType.addEventListener('change', function () {
        if (appointmentType.value === 'Allenamento Funzionale' || appointmentType.value === 'Allenamento EMS') {
            packageSelection.style.display = 'block';
        } else {
            packageSelection.style.display = 'none';
        }
        updateTitle();
    });

    // Carica i pacchetti disponibili per il cliente selezionato
    clientSelect.addEventListener('change', function () {
        const clientId = clientSelect.value;

        if (clientId) {
            fetch(`/get_pacchetti/${clientId}`)
                .then(response => response.json())
                .then(data => {
                    packageSelect.innerHTML = ''; // Svuota il menu a tendina
                    if (data.length > 0) {
                        packageSelection.style.display = 'block';
                        data.forEach(pacchetto => {
                            const option = document.createElement('option');
                            option.value = pacchetto.id;
                            option.textContent = `${pacchetto.nome} - Lezioni rimanenti: ${pacchetto.lezioni_rimanenti}`;
                            packageSelect.appendChild(option);
                        });
                    } else {
                        packageSelection.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Errore durante il caricamento dei pacchetti:', error);
                    packageSelection.style.display = 'none';
                });
        } else {
            packageSelection.style.display = 'none';
        }
        updateTitle();
    });

    // Inizializza il titolo e il campo "Seleziona Pacchetto" al caricamento della pagina
    document.addEventListener('DOMContentLoaded', function () {
        updateTitle();
        if (appointmentType.value === 'Allenamento Funzionale' || appointmentType.value === 'Allenamento EMS') {
            packageSelection.style.display = 'block';
        } else {
            packageSelection.style.display = 'none';
        }
    });
</script>
{% endblock %}

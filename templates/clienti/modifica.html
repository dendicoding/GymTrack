{% extends 'base.html' %}

{% block title %}Modifica Cliente{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="card shadow">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">
                <i class="fas fa-user-edit me-2"></i>Modifica Cliente
            </h5>
        </div>
        <div class="card-body">
            <form method="POST" class="needs-validation" novalidate>
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="row">
                    <div class="col-md-6">
                        <h5 class="mb-3 text-primary">Informazioni Personali</h5>
                        <div class="mb-3">
                            <label for="nome" class="form-label">Nome *</label>
                            <input type="text" class="form-control" id="nome" name="nome" value="{{ cliente['nome'] }}" required>
                        </div>
                        <div class="mb-3">
                            <label for="cognome" class="form-label">Cognome *</label>
                            <input type="text" class="form-control" id="cognome" name="cognome" value="{{ cliente['cognome'] }}" required>
                        </div>
                        <div class="mb-3">
                            <label for="data_nascita" class="form-label">Data di Nascita</label>
                            <input type="date" class="form-control" id="data_nascita" name="data_nascita" value="{{ cliente['data_nascita'] }}">
                        </div>
                        <div class="mb-3">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="email" name="email" value="{{ cliente['email'] }}">
                        </div>
                        <div class="mb-3">
                            <label for="telefono" class="form-label">Telefono *</label>
                            <input type="tel" class="form-control" id="telefono" name="telefono" value="{{ cliente['telefono'] }}" required>
                        </div>
                        <div class="mb-3">
                            <label for="codice_fiscale" class="form-label">Codice Fiscale *</label>
                            <input type="text" class="form-control" id="codice_fiscale" name="codice_fiscale" value="{{ cliente['codice_fiscale'] }}">
                        </div>
                        <div class="mb-3">
                            <label for="tipo" class="form-label">Tipo Cliente</label>
                            <select class="form-select" id="tipo" name="tipo" required>
                                <option value="lead" {% if cliente['tipo'] == 'lead' %}selected{% endif %}>Lead</option>
                                <option value="effettivo" {% if cliente['tipo'] == 'effettivo' %}selected{% endif %}>Effettivo</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="tipologia" class="form-label">Tipologia</label>
                            <select class="form-select" id="tipologia" name="tipologia" required>
                                <option value="EMS" {% if cliente['tipologia'] == 'EMS' %}selected{% endif %}>EMS</option>
                                <option value="VacuLab" {% if cliente['tipologia'] == 'VacuLab' %}selected{% endif %}>VacuLab</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h5 class="mb-3 text-primary">Indirizzo & Taglie</h5>
                        <div class="mb-3">
                            <label for="indirizzo" class="form-label">Indirizzo</label>
                            <input type="text" class="form-control" id="indirizzo" name="indirizzo" value="{{ cliente['indirizzo'] }}">
                        </div>
                        <div class="row">
                            <div class="col-md-8 mb-3">
                                <label for="citta" class="form-label">Citt√†</label>
                                <input type="text" class="form-control" id="citta" name="citta" value="{{ cliente['citta'] }}">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="cap" class="form-label">CAP</label>
                                <input type="text" class="form-control" id="cap" name="cap" value="{{ cliente['cap'] }}">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="taglia_giubotto" class="form-label">Taglia Giubotto</label>
                                <input type="text" class="form-control" id="taglia_giubotto" name="taglia_giubotto" value="{{ cliente['taglia_giubotto'] }}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="taglia_cintura" class="form-label">Taglia Cintura</label>
                                <input type="text" class="form-control" id="taglia_cintura" name="taglia_cintura" value="{{ cliente['taglia_cintura'] }}">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="taglia_braccia" class="form-label">Taglia Braccia</label>
                                <input type="text" class="form-control" id="taglia_braccia" name="taglia_braccia" value="{{ cliente['taglia_braccia'] }}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="taglia_gambe" class="form-label">Taglia Gambe</label>
                                <input type="text" class="form-control" id="taglia_gambe" name="taglia_gambe" value="{{ cliente['taglia_gambe'] }}">
                            </div>
                        </div>
                        <hr>
                        <h5 class="mb-3 text-primary">Sedi</h5>
                        <div class="mb-3">
                            <label for="sede_id" class="form-label">Sede principale *</label>
                            <select class="form-select" id="sede_id" name="sede_id" required onchange="updateSediAggiuntive()">
                                <option value="" disabled>Seleziona una sede</option>
                                {% for sede in sedi %}
                                    <option value="{{ sede.id }}" {% if sede.id == cliente['sede_id'] %}selected{% endif %}>{{ sede.nome }} - {{ sede.citta }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="multi_sede" name="multi_sede"
                                    {% if multi_sede %}checked{% endif %}
                                    onchange="toggleSediAggiuntive()">
                                <label class="form-check-label" for="multi_sede">Cliente multi-sede</label>
                            </div>
                        </div>
                        <div class="mb-3" id="sedi-aggiuntive-container" style="display:none;">
                            <label class="form-label">Seleziona sedi aggiuntive</label>
                            <div id="sedi-aggiuntive-list"></div>
                            <small class="text-muted">Seleziona le sedi aggiuntive (oltre la principale).</small>
                        </div>
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-md-6">
                        <h5 class="mb-3 text-primary">Note</h5>
                        <div class="mb-3">
                            <label for="note" class="form-label">Note Aggiuntive</label>
                            <textarea class="form-control" id="note" name="note" rows="4">{{ cliente['note'] }}</textarea>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h5 class="mb-3 text-primary">Obiettivo Cliente</h5>
                        <div class="mb-3">
                            <label for="obiettivo_cliente" class="form-label">Obiettivo Cliente</label>
                            <textarea class="form-control" id="obiettivo_cliente" name="obiettivo_cliente" rows="4">{{ cliente['obiettivo_cliente'] }}</textarea>
                        </div>
                    </div>
                </div>
                <div class="text-end">
                    <a href="{{ url_for('clienti.dettaglio_cliente', cliente_id=cliente['id']) }}" class="btn btn-secondary">
                        <i class="fas fa-times me-2"></i>Annulla
                    </a>
                    <button type="submit" class="btn btn-primary ms-2">
                        <i class="fas fa-save me-2"></i>Salva Modifiche
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% block scripts %}
<script>
(function () {
    'use strict'
    var forms = document.querySelectorAll('.needs-validation')
    Array.prototype.slice.call(forms).forEach(function (form) {
        form.addEventListener('submit', function (event) {
            if (!form.checkValidity()) {
                event.preventDefault()
                event.stopPropagation()
            }
            form.classList.add('was-validated')
        }, false)
    })
})()

function toggleSediAggiuntive() {
    const checked = document.getElementById('multi_sede').checked;
    document.getElementById('sedi-aggiuntive-container').style.display = checked ? 'block' : 'none';
    updateSediAggiuntive();
}
function updateSediAggiuntive() {
    const container = document.getElementById('sedi-aggiuntive-list');
    const sedePrincipale = document.getElementById('sede_id').value;
    const sedi = [
        {% for sede in sedi %}
        { id: '{{ sede.id }}', nome: '{{ sede.nome }}', citta: '{{ sede.citta }}' },
        {% endfor %}
    ];
    const sediAssociati = {{ sedi_associati|tojson }};
    container.innerHTML = '';
    sedi.forEach(function(sede) {
        if (sede.id !== sedePrincipale && sedePrincipale !== '') {
            const checked = sediAssociati.includes(sede.id);
            const div = document.createElement('div');
            div.className = 'form-check mb-1';
            div.innerHTML = `
                <input class="form-check-input" type="checkbox" name="sedi_aggiuntive" value="${sede.id}" id="sede_add_${sede.id}" ${checked ? 'checked' : ''}>
                <label class="form-check-label" for="sede_add_${sede.id}">${sede.nome} - ${sede.citta}</label>
            `;
            container.appendChild(div);
        }
    });
}
document.addEventListener('DOMContentLoaded', function() {
    toggleSediAggiuntive();
});
document.getElementById('sede_id').addEventListener('change', updateSediAggiuntive);
</script>
{% endblock %}
{% endblock %}